# 生产依赖计算器（可视化版）

[![HTML5](https://img.shields.io/badge/HTML5-E34F26?style=flat&logo=html5&logoColor=white)](https://developer.mozilla.org/en-US/docs/Web/HTML)
[![React](https://img.shields.io/badge/React-20232A?style=flat&logo=react&logoColor=61DAFB)](https://reactjs.org/)
[![TailwindCSS](https://img.shields.io/badge/Tailwind_CSS-38B2AC?style=flat&logo=tailwind-css&logoColor=white)](https://tailwindcss.com/)

> 一个功能强大的本地HTML应用，用于计算和可视化生产链的依赖关系，支持工厂数量计算、人口管理和资源需求分析。
#### **重要提醒**：数据只会自动保存到浏览器本地存储，建议定期使用"导出数据"功能进行手动备份！

## 特性亮点

-  **灵活应用** - 支持手动配置工厂、人口等数据，不同场景灵活运用
-  **可视化图表** - 智能生成生产链依赖关系图
-  **动态计算** - 实时计算工厂数量和资源需求
-  **多格式支持** - JSON完整备份，Excel/CSV批量编辑
-  **纯本地运行** - 无需服务器，双击HTML文件即可使用
-  **数据持久化** - 自动保存到浏览器本地存储，刷新页面数据仍在


## 使用场景

### 游戏应用
- **城市建造游戏**：Anno系列、城市天际线等生产链规划
- **工厂游戏**：异星工厂、戴森球计划等资源配置优化
- **策略游戏**：文明系列、环世界等经济系统分析

### 实际应用
- **制造业**：生产线规划和产能计算
- **供应链**：物料需求计划(MRP)
- **项目管理**：资源需求分析



## 安装使用

1. **下载文件**
   ```bash
   # 克隆仓库
   git clone https://github.com/your-username/production-calculator.git
   
   # 或直接下载 生产计算器.html 文件
   ```

2. **打开应用**
   - 双击 `生产计算器.html` 文件
   - 或在浏览器中打开该文件

3. **开始使用**
   - 点击"载入示例"查看演示数据
   - 或手动添加产品名称和配方
   - 查看可视化结果

### 基本操作

| 操作 | 说明 |
|------|------|
| **添加产品** | 在"产品列表"标签页添加所有需要的产品名称 |
| **创建配方** | 在"配方管理"标签页为每个产品创建生产配方 |
| **设置人口** | 在"人口管理"标签页定义人口类型和消耗 |
| **查看结果** | 右侧自动显示计算结果和可视化图表 |

## 🎯 核心功能

### 📊 数据管理
- **本地存储**：数据自动保存到浏览器本地存储
- **导出功能**：支持JSON、Excel格式导出
- **导入功能**：支持JSON、Excel、CSV格式导入
- **数据清空**：一键清空所有数据

### 🏭 生产配方
- **产品管理**：添加、编辑、删除产品列表
- **配方编辑**：设置生产时间、产量、投入材料
- **用工需求**：配置每个工厂的人力需求
- **期望产量**：设置每种产品的期望净产量

### 👥 人口系统
- **人口种类**：定义不同类型的人口（工人、技师等）
- **理想人数**：设置每种人口的理想数量
- **消耗配置**：设置每人每秒的资源消耗

### 📈 可视化分析
- **依赖关系图**：自动生成生产链的可视化依赖图
- **智能布局**：按依赖关系自动排列节点位置
- **手动调整**：支持手动拖拽调整节点位置

## 🛠️ 技术架构

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | 用户界面框架 |
| ReactFlow | 11.x | 流程图可视化 |
| TailwindCSS | 3.x | CSS框架 |
| Babel | 7.x | JSX转换 |
| XLSX.js | 0.x | Excel文件处理 |

### 核心算法

- **拓扑排序**：解决生产依赖关系，检测循环依赖
- **贪心算法**：优化连接点分配，减少连接线交叉
- **迭代计算**：处理人口消耗反馈循环
- **图论算法**：自动布局和层级计算

## 📋 数据格式

### 配方数据结构

```json
{
  "id": "unique_id",
  "product": "产品名称",
  "timeSec": 2.0,
  "outQty": 1,
  "desiredPerSec": 0.5,
  "inputs": [
    {"item": "原料名", "qty": 2}
  ],
  "staff": [
    {"pop": "工人", "cnt": 3}
  ],
  "note": "备注信息"
}
```

### 人口数据结构

```json
{
  "id": "unique_id",
  "name": "人口名称",
  "ideal": 10,
  "inputs": [
    {"item": "食物", "rate": 0.01}
  ]
}
```

### Excel/CSV格式

#### 配方表格 (recipes)
| product | timeSec | outQty | desiredPerSec | inputs | staff | note |
|---------|---------|--------|---------------|--------|-------|------|
| 木材 | 2 | 1 | 0 | 木头:1 | 工人:2 | 备注 |

#### 人口表格 (populations)
| name | ideal | inputs |
|------|-------|--------|
| 工人 | 5 | 木炭:0.02 |


## 🔄 版本历史

### v1.1.1 (当前版本)
- 🐛 **修复计算逻辑错误**：修正了前置原料需求计算错误的问题
  - 问题：2秒/1产品的工厂，其1秒/1产品的前置需求会错误地加倍而非减半
  - 原因：将"工厂数量"误当作"每秒周期数"来计算原料需求
  - 修复：使用正确公式 `需求速率 × (单周期消耗 / 单周期产出)` 计算原料需求

### v1.1
- ✅ 动态连接点系统
- ✅ 智能连接线避让算法
- ✅ 统一的UI设计语言
- ✅ 固定编辑面板
- ✅ 点击编辑交互模式

### v1.0
- ✅ 基础生产依赖计算
- ✅ 可视化依赖关系图
- ✅ 本地存储功能
- ✅ JSON/Excel导入导出

## 🖥️ 系统要求

### 浏览器支持
- ✅ Chrome 80+
- ✅ Firefox 75+
- ✅ Safari 13+
- ✅ Edge 80+

### 功能要求
- JavaScript ES6+ 支持
- LocalStorage 支持
- File API 支持


## 🤝 贡献指南

### 开发环境
```bash
# 无需构建步骤，直接编辑HTML文件
```

### 代码结构
- **HTML结构**：标准HTML5文档
- **React组件**：使用Babel在线转换JSX
- **样式系统**：TailwindCSS + 自定义CSS
- **状态管理**：React Hooks

## 📊 性能特点

- **轻量级**：单文件应用，无需安装
- **内存友好**：高效的算法实现
- **离线可用**：本地计算，完全离线运行

## 🔒 数据安全

- **本地存储**：数据不会上传到任何服务器
- **隐私保护**：完全在本地浏览器中运行
- **数据备份**：支持JSON导出进行手动备份
- **版本兼容**：向后兼容的数据格式

### 功能建议
欢迎提出功能建议和改进意见！

## 🙏 致谢

感谢以下开源项目：
- [React](https://reactjs.org/) - 用户界面框架
- [ReactFlow](https://reactflow.dev/) - 流程图可视化
- [TailwindCSS](https://tailwindcss.com/) - CSS框架
- [XLSX.js](https://sheetjs.com/) - Excel文件处理

## 📝 技术备忘录

### 生产链需求计算的正确逻辑 (2024-11-14)

**核心原则**：计算原料需求时，必须基于**产出-投入比例**，而非工厂数量。

#### 错误案例分析
假设场景：
- 最终产品工厂：2秒产1个产品（`timeSec=2, outQty=1`）
- 目标需求：1个/秒
- 前置原料工厂：1秒产1个原料

**❌ 错误逻辑**（已修复）：
```javascript
const outPerSec = outQty / timeSec;  // 0.5个/秒
const cyclesPerSec = 需求 / outPerSec;  // 1 / 0.5 = 2（误认为是每秒周期数）
const 原料需求 = cyclesPerSec * inp.qty;  // 2 * 1 = 2个/秒 ❌
```
这里将"需要2个工厂"误当作"每秒运行2个周期"。

**✅ 正确逻辑**：
```javascript
// 每秒需要的原料 = 每秒需要的产品 × (每周期消耗原料 / 每周期产出产品)
const 原料需求 = 产品需求速率 * (inp.qty / outQty);  // 1 * (1/1) = 1个/秒 ✅
```

#### 关键要点
1. **时间因素自然抵消**：生产周期时间会自然地反映在需求比例中
2. **比例守恒**：产出慢的工厂自然需要更少的原料（按速率计算）
3. **单位一致性**：所有计算都基于"每秒"这个统一单位

#### 公式总结
```
原料需求速率 = 产品需求速率 × (单周期原料消耗量 / 单周期产品产出量)
```

这个公式适用于任何生产周期长度，无需单独处理时间因素。

---

<div align="center">

**⭐ 如果这个项目对你有帮助，请给个Star支持一下！**

[🐛 报告问题](../../issues) · [💡 功能建议](../../issues) · [📖 文档](../../wiki)

</div>

---

